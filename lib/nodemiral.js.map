{"version":3,"sources":["../src/nodemiral.js"],"names":["copy","session","_options","callback","options","retries","hostVars","_host","vars","doCopy","src","dest","cb","err","message","solution","timeout","console","log","setTimeout","executeScript","varsMapper","script","createCallback","code","logs","stderr","stdout","substring","length","Error","nodemiral","registerTask","oldApplyTemplate","prototype","_applyTemplate","file","ejsOptions","ejs","filename","call","args"],"mappings":"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","sourcesContent":["import { clone, merge } from 'lodash';\nimport nodemiral from '@zodern/nodemiral';\n\nfunction copy(session, _options, callback) {\n  const options = clone(_options);\n  let retries = 0;\n\n  if (typeof options.hostVars === 'object' && options.hostVars[session._host]) {\n    options.vars = merge(options.vars, options.hostVars[session._host]);\n  }\n\n  function doCopy() {\n    session.copy(options.src, options.dest, options, cb);\n  }\n  function cb(err) {\n    // Check if common error that a known fix\n    if (err) {\n      if (err.message === 'No such file') {\n        err.solution = 'Please run \"mup setup\" to create missing folders on the server.';\n\n        // Skip retries since we will have the same error\n        retries = 10;\n      }\n    }\n\n    retries += 1;\n\n    if (err && retries < 4) {\n      const timeout = retries * 3000;\n\n      console.log('Failed to copy file ', err.message);\n      console.log(`Retrying in ${timeout / 1000} seconds`);\n\n      setTimeout(doCopy, timeout);\n\n      return;\n    }\n    callback(err);\n  }\n\n  doCopy();\n}\n\nfunction executeScript(session, _options, callback, varsMapper) {\n  const options = clone(_options);\n  if (typeof options.hostVars === 'object' && options.hostVars[session._host]) {\n    options.vars = merge(options.vars, options.hostVars[session._host]);\n  }\n\n  session.executeScript(\n    options.script,\n    options,\n    createCallback(callback, varsMapper)\n  );\n}\n\nfunction createCallback(cb, varsMapper) {\n  return function(err, code, logs = {}) {\n    logs.stderr = logs.stderr || '';\n    logs.stdout = logs.stdout || '';\n\n    if (err) {\n      return cb(err);\n    }\n    if (code > 0) {\n      const message = `\n      ------------------------------------STDERR------------------------------------\n      ${logs.stderr.substring(logs.stderr.length - 4200)}\n      ------------------------------------STDOUT------------------------------------\n      ${logs.stdout.substring(logs.stdout.length - 4200)}\n      ------------------------------------------------------------------------------\n      `;\n\n      return cb(new Error(message));\n    }\n\n    if (varsMapper) {\n      varsMapper(logs.stdout, logs.stderr);\n    }\n\n    cb();\n  };\n}\n\nnodemiral.registerTask('copy', copy);\nnodemiral.registerTask('executeScript', executeScript);\n\nconst oldApplyTemplate = nodemiral.session.prototype._applyTemplate;\n// Adds support for using include with ejs\nnodemiral.session.prototype._applyTemplate = function(file, vars, callback) {\n  const ejsOptions = this._options.ejs || {};\n\n  this._options.ejs = {\n    ...ejsOptions,\n    filename: file\n  };\n  oldApplyTemplate.call(this, file, vars, (...args) => {\n    this._options.ejs = ejsOptions;\n    callback(...args);\n  });\n};\n"],"file":"nodemiral.js"}