{"version":3,"sources":["../../src/validate/index.js"],"names":["combineErrorDetails","VALIDATE_OPTIONS","improveErrors","utils","_pluginValidators","addPluginValidator","rootPath","handler","push","generateSchema","topLevelKeys","servers","joi","object","app","plugins","array","_origionalConfig","hooks","pattern","alternatives","localCommand","string","remoteCommand","method","func","Object","keys","forEach","key","any","validateAll","_config","origionalConfig","details","results","config","validate","property","validators","entries","undefined","validator","map","errors","depreciations","problem","type","error","message","depreciation","showErrors","lines","plural","length","console","log","chalk","red","join","showDepreciations","yellow"],"mappings":"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","sourcesContent":["import * as utils from './utils';\nconst { combineErrorDetails, VALIDATE_OPTIONS, improveErrors } = utils;\nimport chalk from 'chalk';\nimport joi from '@hapi/joi';\nimport validateServer from './servers';\n\nexport const _pluginValidators = {};\n\nexport function addPluginValidator(rootPath, handler) {\n  _pluginValidators[rootPath] = _pluginValidators[rootPath] || [];\n  _pluginValidators[rootPath].push(handler);\n}\n\nfunction generateSchema() {\n  const topLevelKeys = {\n    servers: joi.object(),\n    app: joi.object(),\n    plugins: joi.array(),\n    _origionalConfig: joi.object(),\n    hooks: joi.object().pattern(/.*/, joi.alternatives(joi.object({\n      localCommand: joi.string(),\n      remoteCommand: joi.string(),\n      method: joi.func()\n    }),\n    joi.func()\n    ))\n  };\n\n  Object.keys(_pluginValidators).forEach(key => {\n    topLevelKeys[key] = joi.any();\n  });\n\n  return joi.object().keys(topLevelKeys);\n}\n\nfunction validateAll(_config, origionalConfig) {\n  let details = [];\n  let results;\n  // TODO: the config object created by the plugin api\n  // should always have this property.\n  const config = { ..._config, _origionalConfig: origionalConfig };\n\n  results = joi.validate(config, generateSchema(), VALIDATE_OPTIONS);\n  details = combineErrorDetails(details, results);\n\n  if (config.servers) {\n    results = validateServer(config.servers);\n    details = combineErrorDetails(details, results);\n  }\n\n  for (const [property, validators] of Object.entries(_pluginValidators)) {\n    if (config[property] !== undefined) {\n      // eslint-disable-next-line no-loop-func\n      validators.forEach(validator => {\n        results = validator(config, utils);\n        details = combineErrorDetails(details, results);\n      });\n    }\n  }\n\n  return details.map(improveErrors);\n}\n\nexport default function validate(config, origionalConfig) {\n  const errors = [];\n  const depreciations = [];\n\n  validateAll(config, origionalConfig).forEach(problem => {\n    if (problem.type === 'depreciation') {\n      depreciations.push(problem);\n    } else {\n      errors.push(problem);\n    }\n  });\n\n  return {\n    errors: errors.map(error => error.message),\n    depreciations: depreciations.map(depreciation => depreciation.message)\n  };\n}\n\nexport function showErrors(errors) {\n  const lines = [];\n  const plural = errors.length > 1 ? 's' : '';\n\n  lines.push(`${errors.length} Validation Error${plural}`);\n\n  errors.forEach(error => {\n    lines.push(`  - ${error}`);\n  });\n\n  lines.push('');\n\n  console.log(chalk.red(lines.join('\\n')));\n}\n\nexport function showDepreciations(depreciations) {\n  const lines = [];\n  const plural = depreciations.length > 1 ? 's' : '';\n\n  lines.push(`${depreciations.length} Depreciation${plural}`);\n\n  depreciations.forEach(depreciation => {\n    lines.push(`  - ${depreciation}`);\n  });\n\n  lines.push('');\n\n  console.log(chalk.yellow(lines.join('\\n')));\n}\n"],"file":"index.js"}